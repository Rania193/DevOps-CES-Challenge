# ArgoCD Repo Server Patch for helm-secrets plugin
#
# This file patches the argocd-repo-server deployment to enable helm-secrets
# plugin support for SOPS-encrypted Helm values files.
#
# Apply this patch using:
#   kubectl patch deployment argocd-repo-server -n argocd \
#     --patch-file argocd/config/argocd-repo-server-patch.yaml
#
# Prerequisites:
#   1. Create secret with age key:
#      kubectl -n argocd create secret generic helm-secrets-private-keys \
#        --from-file=key.txt=$HOME/.config/sops/age/keys.txt
#   2. Enable helm-secrets schemes in argocd-cm configmap
#
spec:
  template:
    spec:
      # Init container downloads sops and helm-secrets binaries
      initContainers:
        - name: download-tools
          image: alpine:latest
          command: ["/bin/sh", "-c"]
          args:
            - |
              mkdir -p /custom-tools/helm-plugins
              wget -qO /custom-tools/sops https://github.com/getsops/sops/releases/download/v3.8.1/sops-v3.8.1.linux.amd64
              chmod +x /custom-tools/sops
              wget -qO- https://github.com/jkroepke/helm-secrets/releases/download/v4.5.1/helm-secrets.tar.gz | tar -C /custom-tools/helm-plugins -xzf-
              echo "Downloading curl..."
              wget -qO /custom-tools/curl https://github.com/moparisthebest/static-curl/releases/download/v8.5.0/curl-amd64
              chmod +x /custom-tools/curl
              echo "Fixing helm-secrets plugin.yaml warning..."
              sed -i '/^command:/d' /custom-tools/helm-plugins/helm-secrets/plugin.yaml
          volumeMounts:
            - mountPath: /custom-tools
              name: custom-tools

      # Main container configuration
      containers:
        - name: argocd-repo-server
          env:
            # Tell sops where the age key is
            - name: SOPS_AGE_KEY_FILE
              value: /helm-secrets-private-keys/key.txt
            # Tell helm-secrets where sops is
            - name: HELM_SECRETS_SOPS_PATH
              value: /custom-tools/sops
            # Required for ArgoCD
            - name: HELM_SECRETS_VALUES_ALLOW_ABSOLUTE_PATH
              value: "true"
            # Where helm plugins are installed
            - name: HELM_PLUGINS
              value: /custom-tools/helm-plugins
            # Add custom-tools to PATH
            - name: PATH
              value: /custom-tools:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
          volumeMounts:
            # Mount the custom tools
            - mountPath: /custom-tools
              name: custom-tools
            # Mount the age key
            - mountPath: /helm-secrets-private-keys/
              name: helm-secrets-private-keys

      volumes:
        # Empty dir for downloaded tools
        - name: custom-tools
          emptyDir: {}
        # Secret containing your age key
        - name: helm-secrets-private-keys
          secret:
            secretName: helm-secrets-private-keys